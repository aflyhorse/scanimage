# Alpha 通道支持 — 透明背景保留

## 概述

本文档描述了在 scanimage 应用中实现 Alpha 通道（透明度）保留的方案。该功能会自动检测带透明背景的图片，在所有处理步骤中保留 Alpha 通道，并在输出的最终文件中恢复透明度。

## 功能说明

当用户上传包含透明通道的图片（例如带透明背景的 PNG）时：

1. 检测：系统自动判断图片是否包含 Alpha 通道
2. 提取：将 Alpha 通道单独提取并保存
3. 处理：在透视校正和图像调整过程中，对 Alpha 通道应用与 RGB 通道相同的变换
4. 恢复：将处理后的 Alpha 通道与处理后的 RGB 图像合并
5. 输出：最终以支持透明度的 PNG 格式保存，保留透明背景

## 技术实现

### 后端变更（`app.py`）

#### 1. 上传处理（`upload_file`）

- 使用 PIL 检测并识别 Alpha 通道
- 提取 Alpha 通道并将其保存为独立的灰度图像
- 在响应中返回 `has_alpha` 和 `alpha_filename`
- 在启用扩图（添加白边）时，对 Alpha 通道同步进行扩展处理

#### 2. 透视校正（`perspective_correction`）

- 修改函数以接受可选的 `alpha_channel` 参数
- 对 RGB 通道与 Alpha 通道使用相同的透视变换矩阵
- 返回校正后的图像与校正后的 Alpha 通道

#### 3. 图像处理（`process_image`、`reprocess_image`）

- 如果存在则加载 Alpha 通道文件
- 将 Alpha 通道传入透视校正流程
- 在处理后将 Alpha 通道合并回 RGB 图像（使用 `cv2.cvtColor(image, cv2.COLOR_BGR2BGRA)`）
- 使用 PNG 格式保存以保留透明度

### 前端变更（`app.js`）

#### 1. 状态管理

- 在 `savedState` 对象中新增 `hasAlpha` 与 `alphaFilename` 字段
- 上传成功后保存 Alpha 通道信息以便后续请求使用

#### 2. API 调用

- 修改 `processImage()`，在请求体中包含 `alpha_filename`
- 修改 `reprocessImage()`，在请求体中包含 `alpha_filename`
- 修改 `switchColorMode()`，在切换色彩模式时包含 `alpha_filename`

## 使用说明

### 面向用户

无需额外操作。直接上传带透明通道的 PNG：

1. 上传图片（例如带透明背景的 logo）
2. 选择透视校正区域（或不选区域直接处理整图）
3. 选择色彩模式与处理选项
4. 下载结果—透明背景将被保留

### 面向开发者

测试该功能的步骤：

1. 准备一张带透明背景的 PNG 图片
2. 通过 Web 界面上传并处理
3. 验证最终输出文件是否保留透明通道

## 图片格式支持

- 输入：支持 RGBA 或 LA 模式的 PNG，或带透明信息的 P 模式
- 处理：RGB 通道与 Alpha 通道分离处理（RGB 调整不影响 Alpha）
- 输出：使用 BGRA（4 通道）的 PNG 格式

## 限制与注意事项

1. 格式：只有 PNG 能完全支持透明通道。如果输入为 JPEG 等不含 Alpha 的格式，则不会保留透明度（这是预期行为）。

2. 黑白模式：在转换为灰度时，Alpha 通道仍然会被保留，不会被灰度转换影响。

3. 图像调整：亮度、对比度、白平衡等色彩调整仅应用于 RGB 通道，不会修改 Alpha 通道。

4. 文件存储：Alpha 通道会临时以 `alpha_` 前缀保存为灰度图像，存放在上传目录中。

## 示例用例

1. **Logo 扫描**：扫描印刷的 logo 并提取带透明背景的图像
2. **抠图对象**：拍摄带透明或白色背景的物品并保留透明通道
3. **文档叠加**：处理带透明水印或叠加层的文档

## 未来改进

未来可考虑的增强功能：

1. 对非透明图片自动执行背景移除
2. 提供 Alpha 通道编辑（阈值调整）功能
3. 支持对半透明像素的更细致处理
4. 在 UI 中预览 Alpha 通道
